#!/usr/bin/env node

var falafel = require('falafel');
var Promise = require('promise');
var glob = Promise.denodeify(require('glob'));
var read = Promise.denodeify(require('fs').readFile);
var hashNode = require(__dirname + '/../hash_node');

var hashes = {};
var counter = {};
var nodes = {};

glob(process.argv[2], {}).then(function(files) {
  return Promise.all(files.map(function(file) {
    return read(file).then(function(content) {
      falafel(content.toString(), {locations: true}, function(node) {
        var result = hashNode(file, hashes, node);
        var hash = result.hash;
        var children = result.children;
        nodes[hash] = nodes[hash] || [];
        nodes[hash].push({file: file, node: node});
        counter[hash] = counter[hash] || 0;
        counter[hash] = counter[hash] + 1;
      });
    });
  }));
}).then(function(result) {
  Object.keys(nodes).forEach(function(hash) {
    if (counter[hash] > 1 && nodes[hash][0].node.source().length > 300) {
      console.log(hash);
      nodes[hash].forEach(function(node) {
        console.log(node.file + ":" + node.node.loc.start.line);
      });
    }
  });
}).catch(function(err) {
  console.log(err);
  console.log(err.stack);
});
